<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SMART on FHIR v2 Sample App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fhirclient@2.5.3/build/fhir-client.js"></script>
    <style>
      pre { background: #f8f9fa; padding: 1rem; border-radius: .375rem; max-height: 400px; overflow: auto; }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <h1 class="mb-4">SMART on FHIR v2 Sample App</h1>

      <!-- Access Token Info -->
      <div class="card mb-3">
        <div class="card-header">Access Token Info</div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-3">Token Type</dt>
            <dd class="col-sm-9" id="tokenType">—</dd>
            <dt class="col-sm-3">Expires In</dt>
            <dd class="col-sm-9" id="expiresIn">—</dd>
            <dt class="col-sm-3">Granted Scopes</dt>
            <dd class="col-sm-9" id="grantedScopes">—</dd>
          </dl>
        </div>
      </div>

      <!-- Patient Resource -->
      <div class="card mb-3">
        <div class="card-header">Patient Resource</div>
        <div class="card-body">
          <pre id="patientField">Loading...</pre>
        </div>
      </div>

      <!-- ID Token Claims -->
      <div class="card mb-3" id="idTokenCard" style="display:none">
        <div class="card-header">ID Token Claims</div>
        <div class="card-body">
          <pre id="idTokenField"></pre>
        </div>
      </div>

      <!-- Token Response -->
      <div class="card mb-3">
        <div class="card-header">Token Response (raw)</div>
        <div class="card-body">
          <pre id="tokenResponseField">Loading...</pre>
        </div>
      </div>
    </div>

    <script>
      function decodeJwtPayload(token) {
        try {
          var parts = token.split('.');
          if (parts.length !== 3) return null;
          var payload = parts[1].replace(/-/g, '+').replace(/_/g, '/');
          return JSON.parse(atob(payload));
        } catch (e) {
          return null;
        }
      }

      FHIR.oauth2.ready().then(function (client) {
        var tokenResponse = client.state.tokenResponse || {};

        // Access token info
        document.getElementById('tokenType').textContent = tokenResponse.token_type || 'N/A';
        document.getElementById('expiresIn').textContent = tokenResponse.expires_in ? tokenResponse.expires_in + ' seconds' : 'N/A';
        document.getElementById('grantedScopes').textContent = tokenResponse.scope || 'N/A';

        // Token response raw
        document.getElementById('tokenResponseField').textContent = JSON.stringify(tokenResponse, null, 2);

        // ID token
        if (tokenResponse.id_token) {
          var claims = decodeJwtPayload(tokenResponse.id_token);
          if (claims) {
            document.getElementById('idTokenCard').style.display = '';
            document.getElementById('idTokenField').textContent = JSON.stringify(claims, null, 2);
          }
        }

        // Patient resource
        if (client.patient && client.patient.id) {
          client.patient.read().then(
            function (patient) {
              document.getElementById('patientField').textContent = JSON.stringify(patient, null, 2);
            },
            function (err) {
              document.getElementById('patientField').textContent = 'Error reading patient: ' + err.message;
            }
          );
        } else {
          document.getElementById('patientField').textContent = 'No patient context available (launch/patient scope may not have been granted).';
        }
      }).catch(function (err) {
        document.getElementById('patientField').textContent = 'Authorization error: ' + err.message;
        document.getElementById('tokenResponseField').textContent = err.message;
      });
    </script>
  </body>
</html>
