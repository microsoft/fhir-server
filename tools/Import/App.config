<?xml version="1.0" encoding="utf-8" ?>
<configuration>
  <!--
  This code allows to import resources via FHIR service.
  Input data must be provided in ndjson format in one container in Azure blobs storage. 
  
  Performance:
    This client code was tested on gen1 FHIR with Cosmos DB in the backend.
    It allows to import >2.7 billion resources per day (>32K resources/second) on single client VM.
    Throughput can be increased by using >1 client VM.
  
  Prerequisites for performance:
    Cosmos DB is scaled up to >1M RUs/second.
    There are >100K ACUs in app service (test was run on 4 endpoins with 30 P3V2 VMs each).
    Client VM is in Azure in the same datacenter as FHIR service and Cosmos DB. It should have >=16 CPUs and >=100GB RAM.
    UseStringJsonParser=true
    
  Parameters below are set for high scale case. Lower values (10x lower for ReadThreads and WriteThreads) can be chosen in case high perf is not a goal.
  -->
  <appSettings>
    <!-- Azure blob storage parameters -->
    <add key="ConnectionString" value="Connection string to Azure blob storage" />
    <add key="ContainerName" value="Container name which contains files in ndjson format" />
    <!-- FHIR endpoints. Secondary endpoints are optional. They can be used to increase import throughput -->
    <add key="FhirEndpoint" value="https:/(your fhir app service).azurewebsites.net" />
    <add key="FhirEndpoint2" value="" />
    <add key="FhirEndpoint3" value="" />
    <add key="FhirEndpoint4" value="" />
    <!-- Code is processing blobs in ranges. 
         If blobs are grouped in subdirectories with close number of resources per subdirectory, set this value to number of blobs in subdirectory. -->
    <add key="BlobRangeSize" value="19" />
    <!-- Each blob range is processed by one reader thread. Expected value for ReadThreads is >=1 -->
    <add key="ReadThreads" value="20" />
    <!-- WriteThreads is the total number of parallel http calls to FHIR service. Expected value for WriteThreads is >=ReadThreads. -->
    <add key="WriteThreads" value="10000" />
    <!-- NumberOfBlobsToSkip is helpful for process restarts. -->
    <add key="NumberOfBlobsToSkip" value="0" />
    <!-- To load all blobs in container MaxBlobIndexForImport can be set to 0. MaxBlobIndexForImport is 1-based. -->
    <add key="MaxBlobIndexForImport" value="10000" />
    <!-- ReportingPeriodSec is an interval on which status message is outputted to console. -->
    <add key="ReportingPeriodSec" value="30" />
    <!-- If MaxRetries is exceeded and error is not network specific, corresponding resource will not be imported, and error message will be put in the console output. -->
    <add key="MaxRetries" value="10" />
    <!-- UseStringJsonParser=true uses string comparison to get resource type and id from resource JSON instead of converting it to JObject. 
         It might not work for all ndjsons, so it should be tested first, and only then enabled (value set to true). -->
    <add key="UseStringJsonParser" value="false" />
    <!-- UseStringJsonParserCompare allows to compare results of lightweight string parser with convert to JObject. 
         It takes affect only if string parser is enabled. Use true only for test purposes. -->
    <add key="UseStringJsonParserCompare" value="false" />
  </appSettings>
</configuration>
