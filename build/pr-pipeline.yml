# DESCRIPTION: 	
# Builds, tests, and packages the solution for all PR requests.	

trigger: none

variables:
- template: pr-variables.yml
- template: build-variables.yml

stages:
- stage: UpdateVersion
  displayName: 'Determine Semver'
  dependsOn: []
  jobs:
  - job: Semver
    pool:
      name: '$(DefaultLinuxPool)'
      vmImage: '$(LinuxVmImage)'
    steps:
    - template: ./jobs/update-semver.yml  
    - powershell: |
        $buildNumber = "$(semVer)".replace(".", "").replace("-", "")
        $buildNumber = $buildNumber.subString(0, [System.Math]::Min(15, $buildNumber.Length))

        Write-Host "##vso[build.updatebuildnumber]$buildNumber" 
        Write-Host "Updated  build number to '$buildNumber"
      name: SetBuildVersion

- stage: BuildUnitTests
  displayName: 'Build and run unit tests'
  dependsOn:
  - UpdateVersion
  variables:
    assemblySemVer: $[stageDependencies.UpdateVersion.Semver.outputs['SetVariablesFromGitVersion.assemblySemVer']]
    assemblySemFileVer: $[stageDependencies.UpdateVersion.Semver.outputs['SetVariablesFromGitVersion.assemblySemFileVer']]
    informationalVersion: $[stageDependencies.UpdateVersion.Semver.outputs['SetVariablesFromGitVersion.informationalVersion']]
    majorMinorPatch: $[stageDependencies.UpdateVersion.Semver.outputs['SetVariablesFromGitVersion.majorMinorPatch']]
    nuGetVersion: $[stageDependencies.UpdateVersion.Semver.outputs['SetVariablesFromGitVersion.nuGetVersion']]
  jobs:
  - job: Windows_dotnet10
    pool:
      name: '$(DefaultWindowsPool)'
      demands:
        - ImageOverride -equals $(DefaultWindowsImage)
    steps:
    - template: ./jobs/build.yml
      parameters:
        targetBuildFramework: $(defaultBuildFramework)
        unitTest: false
        codeCoverage: true
  - job: Linux_dotnet8
    pool:
      name: '$(DefaultLinuxPool)'
      vmImage: '$(LinuxVmImage)'
    steps:
    - template: ./jobs/build.yml
      parameters:
        targetBuildFramework: 'net8.0'

- stage: BuildArtifacts
  displayName: 'Build artifacts'
  dependsOn:
  - UpdateVersion
  variables:
    assemblySemVer: $[stageDependencies.UpdateVersion.Semver.outputs['SetVariablesFromGitVersion.assemblySemVer']]
    assemblySemFileVer: $[stageDependencies.UpdateVersion.Semver.outputs['SetVariablesFromGitVersion.assemblySemFileVer']]
    informationalVersion: $[stageDependencies.UpdateVersion.Semver.outputs['SetVariablesFromGitVersion.informationalVersion']]
    majorMinorPatch: $[stageDependencies.UpdateVersion.Semver.outputs['SetVariablesFromGitVersion.majorMinorPatch']]
    nuGetVersion: $[stageDependencies.UpdateVersion.Semver.outputs['SetVariablesFromGitVersion.nuGetVersion']]
  jobs:
  - job: Linux_BuildAndPackage
    pool:
      name: '$(DefaultLinuxPool)'
      vmImage: '$(LinuxVmImage)'
    steps:
    - template: ./jobs/build.yml
      parameters:
        codeCoverage: false
        unitTest: false
        componentGovernance: true
        packageArtifacts: true
        packageIntegrationTests: true

- stage: AnalyzeSecurity
  displayName: 'Run Security Analysis and Validate'
  dependsOn:
  - BuildUnitTests
  - BuildArtifacts
  jobs:
  - job: Guardian
    pool:
      name: '$(DefaultWindowsPool)'
      demands:
        - ImageOverride -equals $(DefaultWindowsImage)
    steps:
    - template: ./jobs/analyze.yml

- stage: DockerBuild  
  displayName: 'Build images'
  dependsOn:
  - UpdateVersion
  variables:
    assemblySemFileVer: $[stageDependencies.UpdateVersion.Semver.outputs['SetVariablesFromGitVersion.assemblySemFileVer']]
  jobs:
  - template: ./jobs/docker-build-all.yml
    parameters: 
      tag: $(ImageTag)
      buildPlatform: $(testDockerImagePlatforms)

- stage: cleanupOldResources
  displayName: 'Cleanup Old PR Resources'
  dependsOn: 
  - setupEnvironment
  jobs:
  - job: deleteOldResourceGroups
    displayName: 'Delete Old Resource Groups'
    pool:
      name: '$(DefaultLinuxPool)'
      vmImage: '$(LinuxVmImage)'
    steps:
    - template: ./tasks/delete-resource-groups.yml

- stage: provisionEnvironment
  displayName: Provision Environment
  dependsOn: []
  jobs:
  - job: provision
    displayName: 'Create Resource Group'
    pool:
      name: '$(DefaultLinuxPool)'
      vmImage: '$(LinuxVmImage)'
    steps:
    - task: AzurePowerShell@5
      displayName: Provision Resource Group
      inputs:
        azureSubscription: $(ConnectedServiceName)
        azurePowerShellVersion: latestVersion
        ScriptType: inlineScript
        Inline: |
          # Import retry helper for transient error handling
          . $(System.DefaultWorkingDirectory)/release/scripts/PowerShell/Invoke-WithRetry.ps1

          # Handle re-run scenario: remove existing RG for this build if it exists
          try
          {
            Get-AzResourceGroup -Name $(UniqueResourceGroupName) | Remove-AzResourceGroup -Verbose -Force
          }
          catch
          {}
          # Create new resource group with unique name and retry logic
          Invoke-WithRetry -OperationName "Create Resource Group" -ScriptBlock {
            New-AzResourceGroup -Name "$(UniqueResourceGroupName)" -Location "$(ResourceGroupRegion)" -Force -ErrorAction Stop
          }
          Write-Host "Created resource group: $(UniqueResourceGroupName)"
    - template: ./jobs/add-resource-group-role-assignments.yml
      parameters:
        azureSubscription: $(ConnectedServiceName)
        resourceGroupName: $(UniqueResourceGroupName)

- stage: setupEnvironment
  displayName: Setup Test Environment
  dependsOn:
  - UpdateVersion
  - provisionEnvironment
  jobs:
  - template: ./jobs/cleanup-aad.yml
  - job: deleteKeyVaults
    displayName: 'Delete and Purge Key Vaults'
    pool:
      name: '$(DefaultLinuxPool)'
      vmImage: '$(LinuxVmImage)'
    steps:
    - template: ./tasks/delete-keyvaults.yml
  - job: setup
    displayName: 'Setup AAD'
    dependsOn:
    - cleanupAad
    - deleteKeyVaults
    pool:
      vmImage: '$(WindowsVmImage)'
    steps:
    - template: ./jobs/add-aad-test-environment.yml

- stage: createNsp
  displayName: 'Create Network Security Perimeter'
  dependsOn:
  - provisionEnvironment
  jobs:
  - template: ./jobs/provision-nsp.yml
    parameters:
      resourceGroup: $(UniqueResourceGroupName)
      nspName: 'nsp-$(UniqueResourceGroupName)'
      nspProfile: 'default'

- stage: associateKeyVaultNsp
  displayName: 'Associate KeyVault with NSP'
  dependsOn:
  - setupEnvironment
  - createNsp
  jobs:
  - template: ./jobs/associate-keyvault-nsp.yml
    parameters:
      resourceGroup: $(UniqueResourceGroupName)
      keyVaultName: '$(KeyVaultBaseName)-ts'
      nspName: 'nsp-$(UniqueResourceGroupName)'
      nspProfile: 'default'

- stage: deploySqlServer
  displayName: 'Deploy SQLServer'
  dependsOn:
  - createNsp
  - setupEnvironment
  jobs:
  - template: ./jobs/provision-sqlServer.yml
    parameters:
      resourceGroup: $(UniqueResourceGroupName)
      sqlServerName: $(DeploymentEnvironmentName)
      adminType: 'userAssignedManagedIdentity'
      adminUserAssignedManagedIdentityName: "$(DeploymentEnvironmentName)-uami"
      deploymentName: "AppServer"
      nspName: 'nsp-$(UniqueResourceGroupName)'
  - template: ./jobs/provision-sqlServer.yml
    parameters:
      resourceGroup: $(UniqueResourceGroupName)
      sqlServerName: $(DeploymentEnvironmentName)inttest
      adminType: 'federatedServiceConnection'
      deploymentName: "IntegrationTests"
      nspName: 'nsp-$(UniqueResourceGroupName)'

- stage: deployStu3
  displayName: 'Deploy STU3 CosmosDB Site'
  dependsOn:
  - DockerBuild
  - setupEnvironment
  - createNsp
  jobs:
  - template: ./jobs/provision-deploy.yml
    parameters: 
      version: Stu3
      webAppName: $(DeploymentEnvironmentName)
      keyVaultName: $(KeyVaultBaseName)
      appServicePlanName: '$(appServicePlanName)-cosmos'
      appServicePlanResourceGroup: $(appServicePlanResourceGroup)
      subscription: $(ConnectedServiceName)
      resourceGroup: $(UniqueResourceGroupName)
      testEnvironmentUrl: $(TestApplicationResource)
      imageTag: $(ImageTag)
      reindexEnabled: true

- stage: deployStu3Sql
  displayName: 'Deploy STU3 SQL Site'
  dependsOn:
  - DockerBuild
  - setupEnvironment
  - deploySqlServer
  jobs:
  - template: ./jobs/provision-deploy.yml
    parameters: 
      version: Stu3
      sql: true
      webAppName: $(DeploymentEnvironmentNameSql)
      keyVaultName: $(KeyVaultNameSql)
      appServicePlanName: '$(appServicePlanName)-sql'
      appServicePlanResourceGroup: $(appServicePlanResourceGroup)
      subscription: $(ConnectedServiceName)
      resourceGroup: $(UniqueResourceGroupName)
      testEnvironmentUrl: $(TestApplicationResource)
      imageTag: $(ImageTag)
      schemaAutomaticUpdatesEnabled: 'auto'
      sqlServerName: $(DeploymentEnvironmentName)
      sqlComputeTier: 'Standard'
      reindexEnabled: true

- stage: deployR4
  displayName: 'Deploy R4 CosmosDB Site'
  dependsOn:
  - DockerBuild
  - setupEnvironment
  - createNsp
  jobs:
  - template: ./jobs/provision-deploy.yml
    parameters: 
      version: R4
      webAppName: $(DeploymentEnvironmentNameR4)
      keyVaultName: $(KeyVaultNameR4)
      appServicePlanName: '$(appServicePlanName)-cosmos'
      appServicePlanResourceGroup: $(appServicePlanResourceGroup)
      subscription: $(ConnectedServiceName)
      resourceGroup: $(UniqueResourceGroupName)
      testEnvironmentUrl: $(TestApplicationResource)
      imageTag: $(ImageTag)
      reindexEnabled: true

- stage: deployR4Sql
  displayName: 'Deploy R4 SQL Site'
  dependsOn:
  - DockerBuild
  - setupEnvironment
  - deploySqlServer
  jobs:
  - template: ./jobs/provision-deploy.yml
    parameters: 
      version: R4
      sql: true
      webAppName: $(DeploymentEnvironmentNameR4Sql)
      keyVaultName: $(KeyVaultNameR4Sql)
      appServicePlanName: '$(appServicePlanName)-sql'
      appServicePlanResourceGroup: $(appServicePlanResourceGroup)
      subscription: $(ConnectedServiceName)
      resourceGroup: $(UniqueResourceGroupName)
      testEnvironmentUrl: $(TestApplicationResource)
      imageTag: $(ImageTag)
      schemaAutomaticUpdatesEnabled: 'auto'
      sqlServerName: $(DeploymentEnvironmentName)
      sqlComputeTier: 'Standard'
      reindexEnabled: true

- stage: deployR4B
  displayName: 'Deploy R4B CosmosDB Site'
  dependsOn:
  - DockerBuild
  - setupEnvironment
  - createNsp
  jobs:
  - template: ./jobs/provision-deploy.yml
    parameters: 
      version: R4B
      webAppName: $(DeploymentEnvironmentNameR4B)
      keyVaultName: $(KeyVaultNameR4B)
      appServicePlanName: '$(appServicePlanName)-cosmos'
      appServicePlanResourceGroup: $(appServicePlanResourceGroup)
      subscription: $(ConnectedServiceName)
      resourceGroup: $(UniqueResourceGroupName)
      testEnvironmentUrl: $(TestApplicationResource)
      imageTag: $(ImageTag)
      reindexEnabled: true

- stage: deployR4BSql
  displayName: 'Deploy R4B SQL Site'
  dependsOn:
  - DockerBuild
  - setupEnvironment
  - deploySqlServer
  jobs:
  - template: ./jobs/provision-deploy.yml
    parameters: 
      version: R4B
      sql: true
      webAppName: $(DeploymentEnvironmentNameR4BSql)
      keyVaultName: $(KeyVaultNameR4BSql)
      appServicePlanName: '$(appServicePlanName)-sql'
      appServicePlanResourceGroup: $(appServicePlanResourceGroup)
      subscription: $(ConnectedServiceName)
      resourceGroup: $(UniqueResourceGroupName)
      testEnvironmentUrl: $(TestApplicationResource)
      imageTag: $(ImageTag)
      schemaAutomaticUpdatesEnabled: 'auto'
      sqlServerName: $(DeploymentEnvironmentName)
      sqlComputeTier: 'Standard'
      reindexEnabled: true

- stage: deployR5
  displayName: 'Deploy R5 CosmosDB Site'
  dependsOn:
  - DockerBuild
  - setupEnvironment
  - createNsp
  jobs:
  - template: ./jobs/provision-deploy.yml
    parameters: 
      version: R5
      webAppName: $(DeploymentEnvironmentNameR5)
      keyVaultName: $(KeyVaultNameR5)
      appServicePlanName: '$(appServicePlanName)-cosmos'
      appServicePlanResourceGroup: $(appServicePlanResourceGroup)
      subscription: $(ConnectedServiceName)
      resourceGroup: $(UniqueResourceGroupName)
      testEnvironmentUrl: $(TestApplicationResource)
      imageTag: $(ImageTag)
      reindexEnabled: true

- stage: deployR5Sql
  displayName: 'Deploy R5 SQL Site'
  dependsOn:
  - DockerBuild
  - setupEnvironment
  - deploySqlServer
  jobs:
  - template: ./jobs/provision-deploy.yml
    parameters: 
      version: R5
      sql: true
      webAppName: $(DeploymentEnvironmentNameR5Sql)
      keyVaultName: $(KeyVaultNameR5Sql)
      appServicePlanName: '$(appServicePlanName)-sql'
      appServicePlanResourceGroup: $(appServicePlanResourceGroup)
      subscription: $(ConnectedServiceName)
      resourceGroup: $(UniqueResourceGroupName)
      testEnvironmentUrl: $(TestApplicationResource)
      imageTag: $(ImageTag)
      schemaAutomaticUpdatesEnabled: 'auto'
      sqlServerName: $(DeploymentEnvironmentName)
      sqlComputeTier: 'Standard'
      reindexEnabled: true

- stage: testStu3Cosmos
  displayName: 'Run Stu3 Cosmos Tests'
  dependsOn:
  - BuildArtifacts
  - setupEnvironment
  - deployStu3
  jobs:
  - template: ./jobs/run-cosmos-tests.yml
    parameters:
      version: Stu3
      keyVaultName: $(KeyVaultBaseName)
      appServiceName: $(DeploymentEnvironmentName)

- stage: testStu3Sql
  displayName: 'Run Stu3 SQL Tests'
  dependsOn:
  - BuildArtifacts
  - setupEnvironment
  - deployStu3Sql
  jobs:
  - template: ./jobs/run-sql-tests.yml
    parameters:
      version: Stu3
      keyVaultName: $(KeyVaultBaseName)
      appServiceName: $(DeploymentEnvironmentName)
      integrationSqlServerName: $(DeploymentEnvironmentName)inttest

- stage: testR4Cosmos
  displayName: 'Run R4 Cosmos Tests'
  dependsOn:
  - BuildArtifacts
  - setupEnvironment
  - deployR4
  jobs:
  - template: ./jobs/run-cosmos-tests.yml
    parameters:
      version: R4
      keyVaultName: $(KeyVaultNameR4)
      appServiceName: $(DeploymentEnvironmentNameR4)

- stage: testR4Sql
  displayName: 'Run R4 SQL Tests'
  dependsOn:
  - BuildArtifacts
  - setupEnvironment
  - deployR4Sql
  jobs:
  - template: ./jobs/run-sql-tests.yml
    parameters:
      version: R4
      keyVaultName: $(KeyVaultNameR4)
      appServiceName: $(DeploymentEnvironmentNameR4)
      integrationSqlServerName: $(DeploymentEnvironmentName)inttest

- stage: testR4BCosmos
  displayName: 'Run R4B Cosmos Tests'
  dependsOn:
  - BuildArtifacts
  - setupEnvironment
  - deployR4B
  jobs:
  - template: ./jobs/run-cosmos-tests.yml
    parameters:
      version: R4B
      keyVaultName: $(KeyVaultNameR4B)
      appServiceName: $(DeploymentEnvironmentNameR4B)

- stage: testR4BSql
  displayName: 'Run R4B SQL Tests'
  dependsOn:
  - BuildArtifacts
  - setupEnvironment
  - deployR4BSql
  jobs:
  - template: ./jobs/run-sql-tests.yml
    parameters:
      version: R4B
      keyVaultName: $(KeyVaultNameR4B)
      appServiceName: $(DeploymentEnvironmentNameR4B)
      integrationSqlServerName: $(DeploymentEnvironmentName)inttest

- stage: testR5Cosmos
  displayName: 'Run R5 Cosmos Tests'
  dependsOn:
  - BuildArtifacts
  - setupEnvironment
  - deployR5
  jobs:
  - template: ./jobs/run-cosmos-tests.yml
    parameters:
      version: R5
      keyVaultName: $(KeyVaultNameR5)
      appServiceName: $(DeploymentEnvironmentNameR5)

- stage: testR5Sql
  displayName: 'Run R5 SQL Tests'
  dependsOn:
  - BuildArtifacts
  - setupEnvironment
  - deployR5Sql
  jobs:
  - template: ./jobs/run-sql-tests.yml
    parameters:
      version: R5
      keyVaultName: $(KeyVaultNameR5)
      appServiceName: $(DeploymentEnvironmentNameR5)
      integrationSqlServerName: $(DeploymentEnvironmentName)inttest

- stage: aggregateCoverage
  displayName: 'Aggregate All Coverage Reports'
  dependsOn:
  - BuildUnitTests
  - testStu3Cosmos
  - testStu3Sql
  - testR4Cosmos
  - testR4Sql
  - testR4BCosmos
  - testR4BSql
  - testR5Cosmos
  - testR5Sql
  condition: succeeded()
  jobs:
  - job: AggregateCoverage
    displayName: 'Aggregate coverage from all test types and versions'
    pool:
      name: '$(DefaultLinuxPool)'
      vmImage: '$(LinuxVmImage)'
    steps:
    - template: ./jobs/aggregate-coverage.yml