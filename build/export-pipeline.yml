# DESCRIPTION: 	
# Builds and runs e2e export tests for main branch.	

name: $(SourceBranchName)-$(Date:yyyyMMdd)$(Rev:-r)
trigger: none
pr: none

schedules:
- cron: "0 8 * * *"
  displayName: Daily midnight Pacific time build
  branches:
    include:
    - main

variables:
- template: build-variables.yml

stages:
- stage: Build
  displayName: 'Build and publish packages'
  dependsOn: []
  jobs:
  - job: Linux
    pool:
      name: '$(DefaultLinuxPool)'
      vmImage: '$(LinuxVmImage)'
    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET sdk'
      inputs:
        useGlobalJson: true
    - task: DotNetCoreCLI@2
      displayName: 'dotnet build $(buildConfiguration)'
      inputs:
        command: build
        arguments: '--configuration $(buildConfiguration) /warnaserror -f $(defaultBuildFramework)'
    - template: ./jobs/package-integration-tests.yml

- stage: exportRedeployStu3
  displayName: 'Redeploy Export STU3 Site'
  dependsOn: []
  variables:
  - template: export-variables.yml
  jobs:
  - template: ./jobs/restart-webapp.yml
    parameters: 
      webAppName: $(DeploymentEnvironmentName)
      subscription: $(ConnectedServiceName)

- stage: exportRedeployStu3Sql
  displayName: 'Redeploy Export STU3 SQL Site'
  dependsOn: []
  variables:
  - template: export-variables.yml
  jobs:
  - template: ./jobs/restart-webapp.yml
    parameters: 
      webAppName: $(DeploymentEnvironmentNameSql)
      subscription: $(ConnectedServiceName)

- stage: exportRedeployR4
  displayName: 'Redeploy Export R4 Site'
  dependsOn: []
  variables:
  - template: export-variables.yml
  jobs:
  - template: ./jobs/restart-webapp.yml
    parameters: 
      webAppName: $(DeploymentEnvironmentNameR4)
      subscription: $(ConnectedServiceName)

- stage: exportRedeployR4Sql
  displayName: 'Redeploy Export R4 SQL Site'
  dependsOn: []
  variables:
  - template: export-variables.yml
  jobs:
  - template: ./jobs/restart-webapp.yml
    parameters: 
      webAppName: $(DeploymentEnvironmentNameR4Sql)
      subscription: $(ConnectedServiceName)

- stage: importRedeployStu3Sql
  displayName: 'Redeploy Import STU3 SQL Site'
  dependsOn: []
  variables:
  - template: import-variables.yml
  jobs:
  - template: ./jobs/restart-webapp.yml
    parameters: 
      webAppName: $(DeploymentEnvironmentNameSql)
      subscription: $(ConnectedServiceName)

- stage: importRedeployR4Sql
  displayName: 'Redeploy Import R4 SQL Site'
  dependsOn: []
  variables:
  - template: import-variables.yml
  jobs:
  - template: ./jobs/restart-webapp.yml
    parameters: 
      webAppName: $(DeploymentEnvironmentNameR4Sql)
      subscription: $(ConnectedServiceName)

- stage: testStu3Export
  displayName: 'Run Stu3 Export Tests'
  dependsOn:
  - Build
  - exportRedeployStu3
  - exportRedeployStu3Sql
  variables:
  - template: export-variables.yml
  jobs:
  - template: ./jobs/run-export-tests.yml
    parameters:
      version: Stu3
      keyVaultName: $(DeploymentEnvironmentName)

- stage: testR4Export
  displayName: 'Run R4 Export Tests'
  dependsOn:
  - Build
  - exportRedeployR4
  - exportRedeployR4Sql
  variables:
  - template: export-variables.yml
  jobs:
  - template: ./jobs/run-export-tests.yml
    parameters:
      version: R4
      keyVaultName: $(DeploymentEnvironmentNameR4)

- stage: testStu3Import
  displayName: 'Run Stu3 Import Tests'
  dependsOn:
  - Build
  - importRedeployStu3Sql
  variables:
  - template: import-variables.yml
  jobs:
  - template: ./jobs/run-import-tests.yml
    parameters:
      version: Stu3
      keyVaultName: $(DeploymentEnvironmentName)

- stage: testR4Import
  displayName: 'Run R4 Import Tests'
  dependsOn:
  - Build
  - importRedeployR4Sql
  variables:
  - template: import-variables.yml
  jobs:
  - template: ./jobs/run-import-tests.yml
    parameters:
      version: R4
      keyVaultName: $(DeploymentEnvironmentNameR4)

- stage: cleanExportStorageAccounts
  displayName: 'Clean Export Storage Accounts'
  dependsOn: []
  variables:
  - template: export-variables.yml
  jobs:
  - template: ./jobs/clean-storage-accounts.yml
    parameters:
      environmentName: $(DeploymentEnvironmentName)

- stage: cleanImportStorageAccounts
  displayName: 'Clean Import Storage Accounts'
  dependsOn: []
  variables:
  - template: import-variables.yml
  jobs:
  - template: ./jobs/clean-storage-accounts.yml
    parameters:
      environmentName: $(DeploymentEnvironmentName)
