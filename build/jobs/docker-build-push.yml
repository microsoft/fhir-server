# DESCRIPTION: 
# Builds and pushes a docker image for a given FHIR version

parameters:
- name: version
  type: string
- name: tag
  type: string
- name: buildPlatform
  type: string

jobs:
- job: '${{parameters.version}}_Docker'
  pool:
    name: '$(DefaultLinuxPool)'
    vmImage: '$(LinuxVmImage)'
  steps:
    - task: Docker@2
      displayName: 'Build FHIR ${{parameters.version}} Server Image'
      inputs:
        containerRegistry: $(azureContainerRegistryName)
        repository: '${{parameters.version}}_fhir-server'
        command: 'buildAndPush'
        Dockerfile: './build/docker/Dockerfile'
        tags: |
          ${{parameters.tag}}
        buildContext: .
        arguments: |
          --platform ${{parameters.buildPlatform}} \
          --build-arg FHIR_VERSION=${{parameters.version}} \
          --build-arg ASSEMBLY_VER=$(assemblySemFileVer)
