# DESCRIPTION: 
# Builds and pushes a docker image for a given FHIR version

parameters:
- name: version
  type: string
- name: tag
  type: string
- name: buildPlatform
  type: string

jobs:
- job: '${{parameters.version}}_Docker'
  pool:
    name: '$(DefaultLinuxPool)'
    vmImage: '$(LinuxVmImage)'
  steps:
  - task: AzureCLI@2
    displayName: 'Build FHIR ${{parameters.version}} Server Image'
    inputs:
      azureSubscription: $(azureSubscriptionEndpoint)
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        # Temp install docker
        apt-get -qq update
        apt-get -qq install ca-certificates curl gnupg

        install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --yes --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg

        # Add the repository to apt sources:
        echo "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
          "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
          sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

        # Install the latest version
        apt-get -qq update
        apt-get -qq install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

        # Verify docker has been installed
        docker --version

        TAG="$(azureContainerRegistry)/${{parameters.version}}_fhir-server:${{parameters.tag}}"
        az acr login --name $(azureContainerRegistryName)
        docker buildx create --name fhir-multi-platform --platform ${{parameters.buildPlatform}} --use --bootstrap
        docker buildx build --tag ${TAG,,} \
                      --file ./build/docker/Dockerfile \
                      --platform ${{parameters.buildPlatform}} \
                      --build-arg FHIR_VERSION=${{parameters.version}} \
                      --build-arg ASSEMBLY_VER=$(assemblySemFileVer) \
                      --push .
