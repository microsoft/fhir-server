steps:
- checkout: none

# Download all coverage artifacts from all test stages
- task: DownloadPipelineArtifact@2
  displayName: 'Download all coverage artifacts'
  inputs:
    path: '$(Pipeline.Workspace)/AllCoverage'
    patterns: |
      Coverage_UnitTests/**
      Coverage_IntegrationTests_*/**

# Aggregate all coverage files into a single report
- task: reportgenerator@5
  displayName: 'Aggregate all coverage reports'
  inputs:
    reports: '$(Pipeline.Workspace)/AllCoverage/**/Cobertura.xml'
    reporttypes: 'Cobertura;HtmlInline_AzurePipelines'
    targetdir: '$(Pipeline.Workspace)/AggregatedCoverage'

# Publish the aggregated coverage artifact
- task: PublishBuildArtifacts@1
  displayName: 'Publish aggregated coverage artifact'
  continueOnError: true  # Allow re-runs if artifact already exists
  inputs:
    pathToPublish: '$(Pipeline.Workspace)/AggregatedCoverage'
    artifactName: 'Coverage_Aggregated'
    artifactType: 'container'

# Publish to Azure DevOps for pipeline UI visualization and 1ES telemetry
# Using native .coverage files so @2 can extract proper module/assembly names
# (Cobertura XML via @2 loses module names and stores per-class instead)
- task: PublishCodeCoverageResults@2
  displayName: 'Publish aggregated code coverage to pipeline and 1ES telemetry'
  inputs:
    summaryFileLocation: |
      $(Pipeline.Workspace)/AllCoverage/**/*.coverage
    failIfCoverageEmpty: false

# Upload coverage to Codecov for PR diff coverage checks and comments
- script: |
    curl -Os https://cli.codecov.io/latest/linux/codecov
    chmod +x codecov
    ./codecov --verbose upload-process --disable-search -f $(Pipeline.Workspace)/AggregatedCoverage/Cobertura.xml
  displayName: 'Upload coverage to Codecov'
  condition: succeededOrFailed()
  env:
    CODECOV_TOKEN: $(CODECOV_TOKEN)
