parameters:
- name: version
  type: string
- name: keyVaultName
  type: string
- name: appServiceName
  type: string
- name: integrationSqlServerName
  type: string
jobs:

- job: "CosmosIntegrationTests"
  pool:
    name: '$(SharedLinuxPool)'
    vmImage: '$(LinuxVmImage)'
  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: 'current'
      downloadType: 'single'
      downloadPath: '$(System.ArtifactsDirectory)'
      artifactName: 'IntegrationTests'

  - task: ExtractFiles@1
    displayName: 'Extract Integration Test Binaries'
    inputs:
      archiveFilePatterns: '$(System.ArtifactsDirectory)/IntegrationTests/Microsoft.Health.Fhir.${{ parameters.version }}.Tests.Integration.zip'
      destinationFolder: '$(Agent.TempDirectory)/IntegrationTests/'

  - task: UseDotNet@2
    inputs:
      useGlobalJson: true

  - task: AzureKeyVault@1
    displayName: 'Azure Key Vault: ${{ parameters.keyVaultName }}'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      KeyVaultName: '${{ parameters.keyVaultName }}'

  - task: AzurePowerShell@5
    displayName: 'Set Workload Identity Variables'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      azurePowerShellVersion: latestVersion
      ScriptType: inlineScript
      Inline: |
        Write-Host "##vso[task.setvariable variable=AZURESUBSCRIPTION_CLIENT_ID]$env:AZURESUBSCRIPTION_CLIENT_ID"
        Write-Host "##vso[task.setvariable variable=AZURESUBSCRIPTION_TENANT_ID]$env:AZURESUBSCRIPTION_TENANT_ID"
        Write-Host "##vso[task.setvariable variable=AZURESUBSCRIPTION_SERVICE_CONNECTION_ID]$env:AZURESUBSCRIPTION_SERVICE_CONNECTION_ID"

        $appServiceName = '${{ parameters.appServiceName }}'
        $appSettings = (Get-AzWebApp -ResourceGroupName $(ResourceGroupName) -Name $appServiceName).SiteConfig.AppSettings
        $dataStoreResourceId = $appSettings | where {$_.Name -eq "FhirServer__ResourceManager__DataStoreResourceId"}
        $dataStoreResourceId = $dataStoreResourceId[0].Value
        Write-Host "$dataStoreResourceId"
        Write-Host "##vso[task.setvariable variable=DataStoreResourceId]$($dataStoreResourceId)"

  - task: PowerShell@2
    displayName: 'Run Cosmos Integration Tests and collect coverage (published DLLs)'
    inputs:
      targetType: 'filePath'
      filePath: '$(Build.SourcesDirectory)/tools/run_coverage_on_published_dlls.ps1'
      arguments: "-ArtifactsDir '$(Agent.TempDirectory)/IntegrationTests' -OutDir '$(Agent.TempDirectory)/coverage' -Pattern '*${{ parameters.version }}.Tests.Integration*.dll'"
      pwsh: true
    env:
      'CosmosDb__Host': $(CosmosDb--Host)
      'FhirServer__ResourceManager__DataStoreResourceId': '$(DataStoreResourceId)'
      'CosmosDb__UseManagedIdentity': true
      'AZURESUBSCRIPTION_CLIENT_ID': '$(AZURESUBSCRIPTION_CLIENT_ID)'
      'AZURESUBSCRIPTION_TENANT_ID': '$(AZURESUBSCRIPTION_TENANT_ID)'
      'AZURESUBSCRIPTION_SERVICE_CONNECTION_ID': '$(AZURESUBSCRIPTION_SERVICE_CONNECTION_ID)'
      'SYSTEM_ACCESSTOKEN': $(System.AccessToken)

  - task: PublishBuildArtifacts@1
    displayName: 'Publish integration test coverage'
    inputs:
      pathToPublish: '$(Agent.TempDirectory)/coverage'
      artifactName: 'IntegrationTestsCoverage'
      artifactType: 'container'

  - task: PublishCodeCoverageResults@1
    displayName: 'Publish code coverage results (integration)'
    condition: always()
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: '$(Agent.TempDirectory)/coverage/report/Cobertura.xml'
      reportDirectory: '$(Agent.TempDirectory)/coverage/report'

- job: "SqlIntegrationTests"
  pool:
    name: '$(SharedLinuxPool)'
    vmImage: '$(LinuxVmImage)'
  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: 'current'
      downloadType: 'single'
      downloadPath: '$(System.ArtifactsDirectory)'
      artifactName: 'IntegrationTests'

  - task: ExtractFiles@1
    displayName: 'Extract Integration Test Binaries'
    inputs:
      archiveFilePatterns: '$(System.ArtifactsDirectory)/IntegrationTests/Microsoft.Health.Fhir.${{ parameters.version }}.Tests.Integration.zip'
      destinationFolder: '$(Agent.TempDirectory)/IntegrationTests/'

  - task: UseDotNet@2
    inputs:
      useGlobalJson: true

  - task: AzureKeyVault@1
    displayName: 'Azure Key Vault: ${{ parameters.keyVaultName }}-sql'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      KeyVaultName: '${{ parameters.keyVaultName }}-sql'

  - task: AzurePowerShell@5
    displayName: 'Set Workload Identity Variables'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      azurePowerShellVersion: latestVersion
      ScriptType: inlineScript
      Inline: |
        Write-Host "##vso[task.setvariable variable=AZURESUBSCRIPTION_CLIENT_ID]$env:AZURESUBSCRIPTION_CLIENT_ID"
        Write-Host "##vso[task.setvariable variable=AZURESUBSCRIPTION_TENANT_ID]$env:AZURESUBSCRIPTION_TENANT_ID"
        Write-Host "##vso[task.setvariable variable=AZURESUBSCRIPTION_SERVICE_CONNECTION_ID]$env:AZURESUBSCRIPTION_SERVICE_CONNECTION_ID"

  - task: PowerShell@2
    displayName: 'Run Sql Integration Tests and collect coverage (published DLLs)'
    inputs:
      targetType: 'filePath'
      filePath: '$(Build.SourcesDirectory)/tools/run_coverage_on_published_dlls.ps1'
      arguments: "-ArtifactsDir '$(Agent.TempDirectory)/IntegrationTests' -OutDir '$(Agent.TempDirectory)/coverage' -Pattern '*${{ parameters.version }}.Tests.Integration*.dll'"
      pwsh: true
    env:
      'SqlServer:ConnectionString': 'Server=tcp:${{ parameters.integrationSqlServerName }}.database.windows.net,1433;Initial Catalog=master;Persist Security Info=False;Authentication=ActiveDirectoryWorkloadIdentity;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;User Id=$(AZURESUBSCRIPTION_CLIENT_ID);'
      'AZURESUBSCRIPTION_CLIENT_ID': '$(AZURESUBSCRIPTION_CLIENT_ID)'
      'AZURESUBSCRIPTION_TENANT_ID': '$(AZURESUBSCRIPTION_TENANT_ID)'
      'AZURESUBSCRIPTION_SERVICE_CONNECTION_ID': '$(AZURESUBSCRIPTION_SERVICE_CONNECTION_ID)'
      'SYSTEM_ACCESSTOKEN': $(System.AccessToken)

  - task: PublishBuildArtifacts@1
    displayName: 'Publish integration test coverage'
    inputs:
      pathToPublish: '$(Agent.TempDirectory)/coverage'
      artifactName: 'IntegrationTestsCoverage'
      artifactType: 'container'

- job: 'cosmosE2eTests'
  dependsOn: []
  pool:
    name: '$(SharedLinuxPool)'
    vmImage: '$(LinuxVmImage)'
  steps:
  - template: e2e-setup.yml
  - template: e2e-tests.yml
    parameters:
      version: ${{ parameters.version }}
      appServiceName: ${{ parameters.appServiceName }}
      appServiceType: 'CosmosDb'

- job: 'sqlE2eTests'
  dependsOn: []
  pool:
    name: '$(SharedLinuxPool)'
    vmImage: '$(LinuxVmImage)'
  steps:
  - template: e2e-setup.yml
  - template: e2e-tests.yml
    parameters:
      version: ${{ parameters.version }}
      appServiceName: '${{ parameters.appServiceName }}-sql'
      appServiceType: 'SqlServer'
