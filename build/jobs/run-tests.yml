parameters:
- name: version
  type: string
- name: keyVaultName
  type: string
- name: appServiceName
  type: string
jobs:
- job: "integrationTests"
  pool:
    name: '$(DefaultWindowsPool)'
  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: 'current'
      downloadType: 'single'
      downloadPath: '$(System.ArtifactsDirectory)'
      artifactName: 'IntegrationTests'
  
  - task: ExtractFiles@1
    displayName: 'Extract Integration Test Binaries'
    inputs:
      archiveFilePatterns: '$(System.ArtifactsDirectory)/IntegrationTests/Microsoft.Health.Fhir.${{ parameters.version }}.Tests.Integration.zip'
      destinationFolder: '$(Agent.TempDirectory)/IntegrationTests/'

  - task: UseDotNet@2
    inputs:
      useGlobalJson: true

  - task: AzureKeyVault@1
    displayName: 'Azure Key Vault: ${{ parameters.keyVaultName }}'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      KeyVaultName: '${{ parameters.keyVaultName }}'

  - task: AzureKeyVault@1
    displayName: 'Azure Key Vault: ${{ parameters.keyVaultName }}-sql'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      KeyVaultName: '${{ parameters.keyVaultName }}-sql'

  - task: VSTest@3
    displayName: 'Run Integration Tests'
    inputs:
      testSelector: 'testAssemblies'
      testAssemblyVer2: '**/*${{ parameters.version }}.Tests.Integration*.dll'
      searchFolder: '$(Agent.TempDirectory)/IntegrationTests/'
      testRunTitle: '${{ parameters.version }} Integration'
      otherConsoleOptions: '/Blame:"CollectDump;DumpType=Mini;CollectHangDump;TestTimeout=7min;HangDumpType=Mini"'
      rerunFailedTests: true
      rerunType: 'basedOnTestFailurePercentage'
      rerunFailedThreshold: 10
    env:
      'CosmosDb:Host': $(CosmosDb--Host)
      'CosmosDb:Key': $(CosmosDb--Key)
      'SqlServer:ConnectionString': $(SqlServer--ConnectionString)

  # Publish the crash dump and XML files as build artifacts on failure only
  - task: PublishPipelineArtifact@1
    displayName: 'Publish Integration Test Failures'
    condition: failed()
    continueOnError: true
    inputs:
      targetPath: '$(Agent.TempDirectory)/TestResults'
      artifactName: '${{ parameters.version }} Integration Test Failures'

- job: 'cosmosE2eTests'
  dependsOn: []
  pool:
    name: '$(DefaultWindowsPool)'
  steps:
  - template: e2e-setup.yml
  - template: e2e-tests.yml
    parameters:
      version: ${{ parameters.version }}
      appServiceName: ${{ parameters.appServiceName }}
      appServiceType: 'CosmosDb'

- job: 'sqlE2eTests'
  dependsOn: []
  pool:
    name: '$(DefaultWindowsPool)'
  steps:
  - template: e2e-setup.yml
  - template: e2e-tests.yml
    parameters:
      version: ${{ parameters.version }}
      appServiceName: '${{ parameters.appServiceName }}-sql'
      appServiceType: 'SqlServer'
