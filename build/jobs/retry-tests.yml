parameters:
- name: testCommand
  type: string
- name: testArguments
  type: string
- name: testRunTitle
  type: string
- name: workingDirectory
  type: string
  default: "$(System.ArtifactsDirectory)"
- name: successThreshold
  type: number
  default: 0.95
- name: environmentVariables
  type: object
  default: {}

steps:
- task: PowerShell@2
  displayName: '${{ parameters.testRunTitle }} with Retry Logic'
  inputs:
    filePath: '$(Build.SourcesDirectory)/build/scripts/run-tests-with-retry.ps1'
    arguments: '-TestCommand "${{ parameters.testCommand }}" -TestArguments "${{ parameters.testArguments }}" -TestRunTitle "${{ parameters.testRunTitle }}" -WorkingDirectory "${{ parameters.workingDirectory }}" -SuccessThreshold ${{ parameters.successThreshold }}'
  env: ${{ parameters.environmentVariables }}

- task: PublishTestResults@2
  displayName: 'Publish Test Results'
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/*.trx'
    searchFolder: '$(Agent.TempDirectory)'
    mergeTestResults: true
    testRunTitle: '${{ parameters.testRunTitle }}'
  condition: always()