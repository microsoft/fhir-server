parameters:
- name: version
  type: string
- name: appServiceName
  type: string
- name: appServiceType
  type: string
- name: categoryFilter
  type: string
  default: 'Category!=ExportLongRunning'
- name: testRunTitleSuffix
  type: string
  default: ''

steps:
  - template: e2e-tests-extract.yml
    parameters:
      version: ${{parameters.version}}

  - template: ../tasks/e2e-set-variables.yml
    parameters:
      appServiceName: ${{ parameters.appServiceName }}

  - task: PowerShell@2
    displayName: 'E2E ${{ parameters.version }} ${{parameters.appServiceType}}${{ parameters.testRunTitleSuffix }}'
    inputs:
      pwsh: true
      filePath: '$(Build.SourcesDirectory)/build/scripts/Invoke-TestWithRetry.ps1'
      arguments: >
        -TestAssemblies "$(Agent.TempDirectory)/E2ETests/**/*${{ parameters.version }}.Tests.E2E*.dll"
        -Filter "FullyQualifiedName~${{parameters.appServiceType}}&${{ parameters.categoryFilter }}"
        -MaxRetries 3
        -WorkingDirectory "$(System.ArtifactsDirectory)"
        -AdditionalArgs "--blame-hang-timeout 15m"
        -TestRunTitle "${{ parameters.version }} ${{parameters.appServiceType}}${{ parameters.testRunTitleSuffix }}"
      workingDirectory: "$(System.ArtifactsDirectory)"
    env:
      'TestEnvironmentUrl': $(TestEnvironmentUrl)
      'TestEnvironmentUrl_${{ parameters.version }}': $(TestEnvironmentUrl_${{ parameters.version }})
      'TestEnvironmentUrl_Sql': $(TestEnvironmentUrl_Sql)
      'TestEnvironmentUrl_${{ parameters.version }}_Sql': $(TestEnvironmentUrl_${{ parameters.version }}_Sql)
      'Resource': $(Resource)
      'AllStorageAccounts': $(AllStorageAccounts)
      'TestExportStoreUri': $(TestExportStoreUri)
      'TestIntegrationStoreUri': $(TestIntegrationStoreUri)
      'tenant-admin-service-principal-name': $(tenant-admin-service-principal-name)
      'tenant-admin-service-principal-password': $(tenant-admin-service-principal-password)
      'tenant-admin-user-name': $(tenant-admin-user-name)
      'tenant-admin-user-password': $(tenant-admin-user-password)
      'tenant-id': $(tenant-id)
      'app_globalAdminServicePrincipal_id': $(app_globalAdminServicePrincipal_id)
      'app_globalAdminServicePrincipal_secret': $(app_globalAdminServicePrincipal_secret)
      'app_nativeClient_id': $(app_nativeClient_id)
      'app_nativeClient_secret': $(app_nativeClient_secret)
      'app_wrongAudienceClient_id': $(app_wrongAudienceClient_id)
      'app_wrongAudienceClient_secret': $(app_wrongAudienceClient_secret)
      'app_globalAdminUserApp_id': $(app_globalAdminUserApp_id)
      'app_globalAdminUserApp_secret': $(app_globalAdminUserApp_secret)
      'app_globalConverterUserApp_id': $(app_globalConverterUserApp_id)
      'app_globalConverterUserApp_secret': $(app_globalConverterUserApp_secret)
      'app_globalExporterUserApp_id': $(app_globalExporterUserApp_id)
      'app_globalExporterUserApp_secret': $(app_globalExporterUserApp_secret)
      'app_globalImporterUserApp_id': $(app_globalImporterUserApp_id)
      'app_globalImporterUserApp_secret': $(app_globalImporterUserApp_secret)
      'app_globalReaderUserApp_id': $(app_globalReaderUserApp_id)
      'app_globalReaderUserApp_secret': $(app_globalReaderUserApp_secret)
      'app_globalWriterUserApp_id': $(app_globalWriterUserApp_id)
      'app_globalWriterUserApp_secret': $(app_globalWriterUserApp_secret)
      'app_smartUserClient_id': $(app_smartUserClient_id)
      'app_smartUserClient_secret': $(app_smartUserClient_secret)
      'AZURESUBSCRIPTION_CLIENT_ID': $(AzurePipelinesCredential_ClientId)
      'AZURESUBSCRIPTION_TENANT_ID': $(AZURESUBSCRIPTION_TENANT_ID)
      'AZURESUBSCRIPTION_SERVICE_CONNECTION_ID': $(AZURESUBSCRIPTION_SERVICE_CONNECTION_ID)
      'SYSTEM_ACCESSTOKEN': $(System.AccessToken)
  
  - task: PublishTestResults@2
    displayName: 'Publish E2E Test Results'
    condition: always()
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: '$(TestResultsDirectory)/**/*.trx'
      testRunTitle: '${{ parameters.version }} ${{parameters.appServiceType}}${{ parameters.testRunTitleSuffix }}'
      mergeTestResults: true
      # Enable once PublishTestResults is updated to deal with multiple trx files: https://github.com/microsoft/testfx/issues/7167
      # failTaskOnFailedTests: true
