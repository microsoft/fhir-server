jobs:
- job: DeleteResourceGroup
  displayName: 'Delete resource group'
  pool:
    name: '$(SharedLinuxPool)'
    vmImage: '$(LinuxVmImage)'
  steps:
  - task: AzurePowerShell@5
    displayName: 'Delete resource group'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      azurePowerShellVersion: latestVersion
      ScriptType: InlineScript
      Inline: |
        $vaultName = "$(UniqueKeyVaultName)"
        $vaultLocation = "westus"
        
        Get-AzResourceGroup -Name $(UniqueResourceGroupName) -ErrorVariable notPresent -ErrorAction SilentlyContinue 
        if ($notPresent) {
          Write-Host "Resource group $(UniqueResourceGroupName) not found"
        } else {
          Write-Host "Deleting resource group $(UniqueResourceGroupName)"
          Remove-AzResourceGroup -Name $(UniqueResourceGroupName) -Force -Verbose
        }
        
        # Purge soft-deleted Key Vault to free up quota
        Write-Host "Checking for soft-deleted vault $vaultName..."
        $softDeletedVault = Get-AzKeyVault -VaultName $vaultName -Location $vaultLocation -InRemovedState -ErrorAction SilentlyContinue
        if ($softDeletedVault) {
          Write-Host "Purging soft-deleted vault $vaultName..."
          try {
            Remove-AzKeyVault -VaultName $vaultName -Location $vaultLocation -InRemovedState -Force
            Write-Host "Successfully purged vault $vaultName"
          }
          catch {
            Write-Warning "Failed to purge vault $vaultName. It may have purge protection enabled. Error: $($_.Exception.Message)"
          }
        } else {
          Write-Host "No soft-deleted vault found for $vaultName"
        }
      

- template: ./cleanup-aad.yml

- job: deleteImage
  displayName: 'Delete Image'
  pool:
    name: '$(DefaultLinuxPool)'
    vmImage: '$(LinuxVmImage)'
  steps:
  - task: AzureCLI@2
    displayName: 'Delete Image'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      scriptType: pscore
      scriptLocation: InlineScript
      inlineScript: |
        $repositories = "r4_fhir-server", "r4b_fhir-server", "stu3_fhir-server", "r5_fhir-server"
        foreach ($repositoryName in $repositories) {
          $result = az acr manifest list-metadata --registry $(azureContainerRegistryName) --name $repositoryName --query "[?tags[0]=='$(ImageTag)']" -o tsv
          if ($result -ne $null) {
            Write-Host "Deleting image - $repositoryName $(ImageTag)"
            az acr repository delete --name $(azureContainerRegistryName) --image "${repositoryName}:$(ImageTag)" --yes
          } else {
            Write-Host "Image not found - $repositoryName $(ImageTag)"
          }  
        }
