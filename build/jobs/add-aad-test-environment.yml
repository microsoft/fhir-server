steps:
- task: AzureKeyVault@1
  displayName: 'Azure Key Vault: resolute-oss-tenant-info'
  inputs:
    azureSubscription: $(ConnectedServiceName)
    KeyVaultName: 'resolute-oss-tenant-info'

- task: PowerShell@2
  displayName: Setup AAD Test Environment
  retryCountOnTaskFailure: 1
  inputs:
    pwsh: true
    targetType: inline
    script: |
      # Install only required Microsoft Graph modules for better performance
      # IMPORTANT: Using PowerShell@2 instead of AzurePowerShell@5 to avoid assembly loading conflicts.
      # AzurePowerShell@5 pre-loads Az.Accounts before our script runs, which causes conflicts with
      # Microsoft.Graph.Authentication due to different versions of System.Threading.Tasks.Extensions.dll
      # See: https://github.com/microsoftgraph/msgraph-sdk-powershell/issues/3479
      $graphModules = @(
        'Microsoft.Graph.Authentication',
        'Microsoft.Graph.Applications',
        'Microsoft.Graph.Users',
        'Microsoft.Graph.Identity.DirectoryManagement'
      )
      
      # Install all modules first
      foreach ($module in $graphModules) {
        Install-Module -Name $module -Force -Scope CurrentUser -AllowClobber
      }
      Install-Module -Name Microsoft.PowerShell.SecretManagement -Force -Scope CurrentUser -AllowClobber

      # Import all modules upfront to prevent auto-loading conflicts
      foreach ($module in $graphModules) {
        Import-Module -Name $module -ErrorAction Stop
      }

      $module = Get-Module -Name Microsoft.Graph.Authentication -ListAvailable | Select-Object -First 1
      Write-Host "Microsoft.Graph.Authentication version: $($module.Version)"

      $tenantId = "$(tenant-id)"

      # Set up Microsoft Graph authentication
      $username = "$(tenant-admin-service-principal-name)"
      $clientId = "$(tenant-admin-service-principal-id)"
      $password_raw =  "$(tenant-admin-service-principal-password)"
      $password =  ConvertTo-SecureString -AsPlainText $password_raw -Force
      $clientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $clientId, $password

      $environmentName = "$(DeploymentEnvironmentName)".ToLower() -replace "\.", "" 
      $keyVaultName = "$(KeyVaultBaseName)-ts".ToLower() -replace "\.", ""
      Write-Host "Installed module and set variables"

      # Connect to Microsoft Graph using client credentials
      Write-Host "Connecting to Microsoft Graph"
      Connect-MgGraph -TenantId $tenantId -ClientSecretCredential $clientSecretCredential

      Write-Host "Connected to Microsoft Graph"
      Import-Module $(System.DefaultWorkingDirectory)/samples/scripts/PowerShell/FhirServer/FhirServer.psd1
      Import-Module $(System.DefaultWorkingDirectory)/release/scripts/PowerShell/FhirServerRelease/FhirServerRelease.psd1

      Write-Host "Imported modules"
      $output = Add-AadTestAuthEnvironment -TestAuthEnvironmentPath $(System.DefaultWorkingDirectory)/testauthenvironment.json -EnvironmentName $environmentName -KeyVaultName $keyVaultName -ResourceGroupName $(UniqueResourceGroupName) -EnvironmentLocation $(ResourceGroupRegion) -TenantAdminCredential $clientSecretCredential -TenantId $tenantId -ClientId $clientId -ClientSecret $password
