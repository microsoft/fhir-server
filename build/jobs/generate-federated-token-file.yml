parameters:
- name: serviceConnectionName
  type: string

steps:
- task: AzurePowerShell@5
  displayName: Generate Federated Token File
  inputs:
    azureSubscription: ${{ parameters.serviceConnectionName }}
    azurePowerShellVersion: latestVersion
    ScriptType: inlineScript
    Inline: |
      Write-Output "Starting to generate federated token file..."
      
      # Request fresh idToken
      Write-Output "Requesting fresh idToken..."
      $response = Invoke-WebRequest -Headers @{
                        Authorization  = "Bearer $(System.AccessToken)"
                        'Content-Type' = 'application/json'
                      } `
                      -Uri "${env:SYSTEM_OIDCREQUESTURI}?api-version=7.1&serviceConnectionId=${env:AZURESUBSCRIPTION_SERVICE_CONNECTION_ID}" `
                      -Method Post -ErrorAction Stop
      
      $responseCode = $response.StatusCode
      Write-Output "Response code: $responseCode"

      $idToken = ($response.Content | ConvertFrom-Json).oidcToken
      Write-Output "Received idToken."

      # Write token to file
      $env:AZURE_FEDERATED_TOKEN_FILE = "$(Agent.TempDirectory)/azToken.txt"
      $idToken | Out-File -FilePath $env:AZURE_FEDERATED_TOKEN_FILE
      Write-Output "Token written to file: $env:AZURE_FEDERATED_TOKEN_FILE"
      
      # Set the Azure DevOps output variable
      Write-Output "Setting Azure DevOps output variable for token file..."
      Write-Output "##vso[task.setvariable variable=AZURE_FEDERATED_TOKEN_FILE]$env:AZURE_FEDERATED_TOKEN_FILE"
      
      # Retrieve clientId and tenantId
      Write-Output "Retrieving clientId and tenantId..."
      $clientId = (Get-AzContext).Account.Id
      $tenantId = (Get-AzContext).Tenant.Id
      Write-Output "clientId: $clientId"
      Write-Output "tenantId: $tenantId"

      # Set the Azure DevOps output variables for clientId and tenantId
      Write-Output "Setting Azure DevOps output variables for clientId and tenantId..."
      Write-Output "##vso[task.setvariable variable=AZURE_CLIENT_ID]$clientId"
      Write-Output "##vso[task.setvariable variable=AZURE_TENANT_ID]$tenantId"

      Write-Output "Finished generating federated token file."
