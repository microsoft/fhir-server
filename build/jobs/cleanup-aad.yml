jobs:
- job: cleanupAad
  displayName: 'Cleanup AAD'
  pool:
    vmImage: '$(WindowsVmImage)'
  steps:
  - task: AzureKeyVault@1
    displayName: 'Azure Key Vault: resolute-oss-tenant-info'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      KeyVaultName: 'resolute-oss-tenant-info'

  - task: AzurePowerShell@5
    displayName: 'Delete AAD apps'
    inputs:
      azureSubscription: $(ConnectedServiceName)
      azurePowerShellVersion: latestVersion
      ScriptType: InlineScript
      Inline: |
        # Install only required Microsoft Graph modules for better performance
        Install-Module -Name Microsoft.Graph.Authentication -Force
        Install-Module -Name Microsoft.Graph.Applications -Force
        Install-Module -Name Microsoft.Graph.Users -Force
        Install-Module -Name Microsoft.Graph.Identity.DirectoryManagement -Force
        
        $username = "$(tenant-admin-user-name)"
        $clientId = "$(tenant-admin-service-principal-name)"
        $clientSecret = "$(tenant-admin-service-principal-password)"
        $clientSecret_secure =  ConvertTo-SecureString -AsPlainText $clientSecret -Force
        $tenantId = "$(tenant-id)"

        # Create PSCredential for Microsoft Graph authentication
        $clientSecretCredential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $clientId, $clientSecret_secure

        # Connect to Microsoft Graph using client credentials
        Connect-MgGraph -TenantId $tenantId -ClientSecretCredential $clientSecretCredential

        Import-Module $(System.DefaultWorkingDirectory)/samples/scripts/PowerShell/FhirServer/FhirServer.psd1
        Import-Module $(System.DefaultWorkingDirectory)/release/scripts/PowerShell/FhirServerRelease/FhirServerRelease.psd1

        Remove-AadTestAuthEnvironment -TestAuthEnvironmentPath $(System.DefaultWorkingDirectory)/testauthenvironment.json -EnvironmentName $(DeploymentEnvironmentName) -TenantId $tenantId -ClientId $clientId -ClientSecret $clientSecret_secure
