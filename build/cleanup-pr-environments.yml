# DESCRIPTION: 	
# Removes resource groups used in PRs.
# The Exclude variable can be used to preserve specific resource groups. It is a comma seperated list of the full resource group names. 
# The DeleteRecent variable can be used to delete recent runs. Otherwise only resource groups with no deployments in the last week will be deleted.

variables:
- template: build-variables.yml
- template: pr-variables.yml

stages:
- stage: CleanupRGs
  displayName: 'Cleanup Resource Groups'
  jobs:
  - job: DeleteResourceGroup
    displayName: 'Delete resource group'
    pool:
      name: '$(SharedLinuxPool)'
      vmImage: '$(LinuxVmImage)'
    steps:
    - task: AzurePowerShell@5
      displayName: 'Delete resource group'
      inputs:
        azureSubscription: $(ConnectedServiceName)
        azurePowerShellVersion: latestVersion
        ScriptType: InlineScript
        Inline: |
          Write-Host "Starting"

          # Function to clean up Network Security Perimeter resources
          # NSP associations block resource group deletion if not removed first
          function Remove-NspResources {
            param([string]$ResourceGroupName)
            
            Write-Host "  Cleaning up Network Security Perimeters in $ResourceGroupName"
            try {
              $nsps = Get-AzResource -ResourceGroupName $ResourceGroupName -ResourceType "Microsoft.Network/networkSecurityPerimeters" -ErrorAction SilentlyContinue
              
              if ($nsps) {
                foreach ($nsp in $nsps) {
                  Write-Host "    Found NSP: $($nsp.Name)"
                  $nspResourceId = $nsp.ResourceId
                  
                  # Remove associations first
                  $associations = Get-AzResource -ResourceId "$nspResourceId/resourceAssociations" -ApiVersion "2023-08-01-preview" -ErrorAction SilentlyContinue
                  if ($associations) {
                    foreach ($assoc in $associations) {
                      Write-Host "      Removing association: $($assoc.Name)"
                      Remove-AzResource -ResourceId $assoc.ResourceId -ApiVersion "2023-08-01-preview" -Force -ErrorAction SilentlyContinue
                    }
                  }
                  
                  # Delete the NSP itself
                  Write-Host "    Deleting NSP: $($nsp.Name)"
                  Remove-AzResource -ResourceId $nspResourceId -ApiVersion "2023-08-01-preview" -Force -ErrorAction SilentlyContinue
                }
                return $true
              }
            }
            catch {
              Write-Warning "  Error cleaning up NSPs in $ResourceGroupName : $($_.Exception.Message)"
            }
            return $false
          }

          Write-Host ${env:Exclude}
          try {
            $excludeList = ${env:Exclude}.Split(',').Trim()
          }
          catch {
          }

          Write-Host "Getting resource groups"
          $resourceGroups = Get-AzResourceGroup -Name "$(resourceGroupRoot)*" -Location "$(ResourceGroupRegion)" | Where ResourceGroupName -NotIn $excludeList 

          Write-Host "Finding cutoff time"
          $cutoffTime = Get-Date
          If (${env:DeleteRecent} -ne $true)
          {
            $cutoffTime = $cutoffTime.AddDays(-7)
          }

          $successCount = 0
          $failedCount = 0
          $skippedCount = 0
          $failedGroups = @()

          ForEach ($group in $resourceGroups)
          {
            try {
              $deploymentTimes = Get-AzResourceGroupDeployment -ResourceGroupName $group.ResourceGroupName -ErrorAction SilentlyContinue | Select Timestamp | Where Timestamp -lt $cutoffTime
              If ($deploymentTimes.Count -gt 0)
              {
                Write-Host "Deleting $($group.ResourceGroupName)"
                
                try {
                  Remove-AzResourceGroup -Name $group.ResourceGroupName -Verbose -Force -ErrorAction Stop
                  $successCount++
                  Write-Host "Successfully deleted $($group.ResourceGroupName)"
                }
                catch {
                  $errorMessage = $_.Exception.Message
                  
                  # Check if failure is due to Network Security Perimeter
                  if ($errorMessage -match "networkSecurityPerimeter" -or $errorMessage -match "ResourceGroupDeletionBlocked") {
                    Write-Warning "Resource group deletion blocked, likely due to NSP. Attempting NSP cleanup..."
                    $nspFound = Remove-NspResources -ResourceGroupName $group.ResourceGroupName
                    
                    if ($nspFound) {
                      Write-Host "NSP cleanup completed. Retrying resource group deletion..."
                      # Retry deletion after NSP cleanup
                      Remove-AzResourceGroup -Name $group.ResourceGroupName -Verbose -Force -ErrorAction Stop
                      $successCount++
                      Write-Host "Successfully deleted $($group.ResourceGroupName) after NSP cleanup"
                    }
                    else {
                      # No NSP found but still failed - rethrow
                      throw
                    }
                  }
                  else {
                    # Not an NSP error - rethrow
                    throw
                  }
                }
              }
              else
              {
                $skippedCount++
                Write-Host "Skipping $($group.ResourceGroupName) - has recent deployments"
              }
            }
            catch {
              $failedCount++
              $failedGroups += $group.ResourceGroupName
              Write-Warning "Failed to delete $($group.ResourceGroupName): $($_.Exception.Message)"
              # Continue processing remaining resource groups
            }
          }

          Write-Host ""
          Write-Host "=========================================="
          Write-Host "Cleanup Summary:"
          Write-Host "  Successfully deleted: $successCount"
          Write-Host "  Skipped (recent deployments): $skippedCount"
          Write-Host "  Failed: $failedCount"
          if ($failedGroups.Count -gt 0) {
            Write-Host "  Failed groups: $($failedGroups -join ', ')"
          }
          Write-Host "=========================================="

          # Exit with error if any deletions failed, but only after processing all groups
          if ($failedCount -gt 0) {
            Write-Error "Failed to delete $failedCount resource group(s). See warnings above for details."
          }
