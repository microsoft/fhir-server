# DESCRIPTION: 	
# Removes resource groups used in PRs.
# The Exclude variable can be used to preserve specific resource groups. It is a comma seperated list of the full resource group names. 
# The DeleteRecent variable can be used to delete recent runs. Otherwise only resource groups with no deployments in the last week will be deleted.

variables:
- template: build-variables.yml
- template: pr-variables.yml

stages:
- stage: CleanupRGs
  displayName: 'Cleanup Resource Groups'
  jobs:
  - job: DeleteResourceGroup
    displayName: 'Delete resource group'
    pool:
      name: '$(SharedLinuxPool)'
      vmImage: '$(LinuxVmImage)'
    steps:
    - task: AzurePowerShell@5
      displayName: 'Delete resource group'
      inputs:
        azureSubscription: $(ConnectedServiceName)
        azurePowerShellVersion: latestVersion
        ScriptType: InlineScript
        Inline: |
          Write-Host "Starting"

          Write-Host ${env:Exclude}
          try {
            $excludeList = ${env:Exclude}.Split(',').Trim()
          }
          catch {
          }

          Write-Host "Getting resource groups"
          $resourceGroups = Get-AzResourceGroup -Name "$(resourceGroupRoot)*" -Location "$(ResourceGroupRegion)" | Where ResourceGroupName -NotIn $excludeList 

          Write-Host "Finding cutoff time"
          $cutoffTime = Get-Date
          If (${env:DeleteRecent} -ne $true)
          {
            $cutoffTime = $cutoffTime.AddDays(-7)
          }

          $successCount = 0
          $failedCount = 0
          $skippedCount = 0
          $failedGroups = @()

          ForEach ($group in $resourceGroups)
          {
            try {
              $deploymentTimes = Get-AzResourceGroupDeployment -ResourceGroupName $group.ResourceGroupName -ErrorAction SilentlyContinue | Select Timestamp | Where Timestamp -lt $cutoffTime
              If ($deploymentTimes.Count -gt 0)
              {
                Write-Host "Deleting $($group.ResourceGroupName)"
                Remove-AzResourceGroup -Name $group.ResourceGroupName -Verbose -Force -ErrorAction Stop
                $successCount++
                Write-Host "Successfully deleted $($group.ResourceGroupName)"
              }
              else
              {
                $skippedCount++
                Write-Host "Skipping $($group.ResourceGroupName) - has recent deployments"
              }
            }
            catch {
              $failedCount++
              $failedGroups += $group.ResourceGroupName
              Write-Warning "Failed to delete $($group.ResourceGroupName): $($_.Exception.Message)"
              # Continue processing remaining resource groups
            }
          }

          Write-Host ""
          Write-Host "=========================================="
          Write-Host "Cleanup Summary:"
          Write-Host "  Successfully deleted: $successCount"
          Write-Host "  Skipped (recent deployments): $skippedCount"
          Write-Host "  Failed: $failedCount"
          if ($failedGroups.Count -gt 0) {
            Write-Host "  Failed groups: $($failedGroups -join ', ')"
          }
          Write-Host "=========================================="

          # Exit with error if any deletions failed, but only after processing all groups
          if ($failedCount -gt 0) {
            Write-Error "Failed to delete $failedCount resource group(s). See warnings above for details."
          }
