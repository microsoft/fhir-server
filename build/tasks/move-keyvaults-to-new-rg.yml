# Task template to move Key Vaults from old resource groups to the current resource group
# This prevents soft-delete conflicts when old RGs are deleted

steps:
- task: AzurePowerShell@5
  displayName: 'Move Key Vaults to Current RG'
  inputs:
    azureSubscription: $(ConnectedServiceName)
    azurePowerShellVersion: latestVersion
    ScriptType: inlineScript
    Inline: |
      $deploymentEnvName = "$(DeploymentEnvironmentName)"
      $targetRgName = "$(UniqueResourceGroupName)"
      $region = "$(ResourceGroupRegion)"
      $pattern = "$deploymentEnvName*"
      
      Write-Host "Looking for Key Vaults matching pattern: $pattern in region: $region"
      Write-Host "Target resource group: $targetRgName"
      
      # Get all key vaults matching the pattern that are not already in the target RG
      $vaults = Get-AzKeyVault | Where-Object { 
        $_.VaultName -like $pattern -and 
        $_.Location -eq $region -and
        $_.ResourceGroupName -ne $targetRgName
      }
      
      if ($null -eq $vaults -or $vaults.Count -eq 0) {
        Write-Host "No Key Vaults found to move"
      } else {
        Write-Host "Found $($vaults.Count) Key Vault(s) to move"
        
        # Filter out vaults with resource locks before parallel processing
        $vaultsToMove = $vaults | Where-Object {
          $locks = Get-AzResourceLock -ResourceGroupName $_.ResourceGroupName -ResourceName $_.VaultName -ResourceType "Microsoft.KeyVault/vaults" -ErrorAction SilentlyContinue
          if ($locks) {
            Write-Warning "Vault '$($_.VaultName)' has resource locks - skipping move"
            return $false
          }
          return $true
        }
        
        if ($vaultsToMove.Count -eq 0) {
          Write-Host "No vaults eligible for move after lock check"
        } else {
          Write-Host "Moving $($vaultsToMove.Count) vault(s) in parallel..."
          
          $results = $vaultsToMove | ForEach-Object -Parallel {
            $vaultName = $_.VaultName
            $sourceRg = $_.ResourceGroupName
            $destRg = $using:targetRgName
            try {
              $resource = Get-AzResource -ResourceGroupName $sourceRg -ResourceName $vaultName -ResourceType "Microsoft.KeyVault/vaults"
              Move-AzResource -DestinationResourceGroupName $destRg -ResourceId $resource.ResourceId -Force -ErrorAction Stop
              [PSCustomObject]@{ Vault = $vaultName; Status = "Moved" }
            }
            catch {
              # Move failed - force delete so it can be recreated later
              Write-Warning "Move failed for '$vaultName', attempting force delete..."
              try {
                Remove-AzKeyVault -VaultName $vaultName -ResourceGroupName $sourceRg -Force -ErrorAction Stop
                [PSCustomObject]@{ Vault = $vaultName; Status = "Deleted" }
              }
              catch {
                [PSCustomObject]@{ Vault = $vaultName; Status = "Failed: $($_.Exception.Message)" }
              }
            }
          } -ThrottleLimit 10
          
          $results | ForEach-Object {
            if ($_.Status -eq "Moved") {
              Write-Host "Successfully moved vault: $($_.Vault)"
            } elseif ($_.Status -eq "Deleted") {
              Write-Host "Deleted vault (move failed): $($_.Vault)"
            } else {
              Write-Warning "$($_.Vault): $($_.Status)"
            }
          }
          
          $movedCount = ($results | Where-Object { $_.Status -eq "Moved" }).Count
          $deletedCount = ($results | Where-Object { $_.Status -eq "Deleted" }).Count
          Write-Host "Completed: $movedCount moved, $deletedCount deleted of $($vaultsToMove.Count) vaults"
        }
      }
